{% extends "layout.html" %}

{% block title %}Prescribir Medicamento - Consulta {{ consulta.fecha_consulta.strftime('%d/%m/%Y') }}{% endblock %}

{% block content %}
<style>
body {
    background: url("{{ url_for('static', filename='media/doc3.jpg') }}") center center no-repeat;
    background-size: cover;
}
</style>

<div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 py-8">
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Encabezado -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center">
            <a href="{{ url_for('ver_consulta', id=consulta.id) }}" 
               class="inline-flex items-center px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors duration-200 mr-4">
                <i class="fas fa-arrow-left mr-2"></i> Volver
            </a>
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Prescribir Medicamento</h1>
                <p class="text-lg text-gray-600">{{ historia.nombre_mascota }} - Consulta del {{ consulta.fecha_consulta.strftime('%d/%m/%Y') }}</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Formulario Principal -->
        <div class="lg:col-span-2">
            <form method="POST" class="space-y-8">
                
                <!-- Selección de Medicamento -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-pills text-green-600"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Selección de Medicamento</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="idmedicamento" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-capsules text-green-500 mr-2"></i>
                                Medicamento <span class="text-red-500 ml-1">*</span>
                            </label>
                            <select name="idmedicamento" id="idmedicamento" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Seleccione un medicamento...</option>
                                {% for medicamento in medicamentos %}
                                <option value="{{ medicamento.Idmedicamento }}" 
                                        data-presentacion="{{ medicamento.presentacion or '' }}">
                                    {{ medicamento.nombre }} 
                                    {% if medicamento.presentacion %} - {{ medicamento.presentacion }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Información del medicamento seleccionado -->
                        <div id="info-medicamento" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">Información del Medicamento</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p><span class="font-medium">Principio Activo:</span> <span id="principio-activo"></span></p>
                                <p><span class="font-medium">Forma Farmacéutica:</span> <span id="forma-farmaceutica"></span></p>
                                <p><span class="font-medium">Concentración:</span> <span id="concentracion"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posología -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-clock text-blue-600"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Posología</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="dosis" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-balance-scale text-blue-500 mr-2"></i>
                                Dosis <span class="text-red-500 ml-1">*</span>
                            </label>
                            <input type="text" name="dosis" id="dosis" required
                                   placeholder="Ej: 10 mg/kg, 1 comprimido, 5 ml"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <p class="mt-1 text-xs text-gray-500">Especifique la cantidad exacta por toma</p>
                        </div>
                        
                        <div>
                            <label for="frecuencia" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-redo text-blue-500 mr-2"></i>
                                Frecuencia <span class="text-red-500 ml-1">*</span>
                            </label>
                            <select name="frecuencia" id="frecuencia" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Seleccione frecuencia...</option>
                                <option value="Cada 6 horas">Cada 6 horas (4 veces al día)</option>
                                <option value="Cada 8 horas">Cada 8 horas (3 veces al día)</option>
                                <option value="Cada 12 horas">Cada 12 horas (2 veces al día)</option>
                                <option value="Cada 24 horas">Cada 24 horas (1 vez al día)</option>
                                <option value="Cada 48 horas">Cada 48 horas (día por medio)</option>
                                <option value="SOS">Según necesidad (SOS)</option>
                                <option value="Personalizada">Personalizada</option>
                            </select>
                        </div>
                        
                        <div id="frecuencia-personalizada" class="hidden col-span-2">
                            <label for="frecuencia_custom" class="block text-sm font-semibold text-gray-700 mb-2">
                                Especifique la frecuencia
                            </label>
                            <input type="text" name="frecuencia_custom" id="frecuencia_custom"
                                   placeholder="Ej: 2 veces al día con las comidas"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="via_administracion" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-syringe text-blue-500 mr-2"></i>
                                Vía de Administración
                            </label>
                            <select name="via_administracion" id="via_administracion"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Seleccione vía...</option>
                                <option value="Oral">Oral</option>
                                <option value="Subcutánea">Subcutánea</option>
                                <option value="Intramuscular">Intramuscular</option>
                                <option value="Intravenosa">Intravenosa</option>
                                <option value="Tópica">Tópica</option>
                                <option value="Ótica">Ótica</option>
                                <option value="Oftálmica">Oftálmica</option>
                                <option value="Rectal">Rectal</option>
                                <option value="Inhalatoria">Inhalatoria</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="duracion" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-calendar text-blue-500 mr-2"></i>
                                Duración del Tratamiento
                            </label>
                            <input type="text" name="duracion" id="duracion"
                                   placeholder="Ej: 7 días, 2 semanas, hasta mejoría"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Instrucciones Especiales -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Instrucciones y Precauciones</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="instrucciones" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                                Instrucciones Especiales
                            </label>
                            <textarea name="instrucciones" id="instrucciones" rows="4"
                                      placeholder="Instrucciones especiales para la administración del medicamento..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="con_alimento" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-utensils text-yellow-500 mr-2"></i>
                                    Administración con Alimento
                                </label>
                                <select name="con_alimento" id="con_alimento"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">No especificado</option>
                                    <option value="Con alimento">Con alimento</option>
                                    <option value="Sin alimento">Sin alimento (en ayunas)</option>
                                    <option value="Indiferente">Indiferente</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="fecha_inicio" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-play text-yellow-500 mr-2"></i>
                                    Fecha de Inicio
                                </label>
                                <input type="date" name="fecha_inicio" id="fecha_inicio"
                                       value="{{ consulta.fecha_consulta.strftime('%Y-%m-%d') }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label for="observaciones" class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-clipboard text-yellow-500 mr-2"></i>
                                Observaciones Adicionales
                            </label>
                            <textarea name="observaciones" id="observaciones" rows="3"
                                      placeholder="Efectos secundarios a vigilar, contraindicaciones, etc..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-end space-x-4">
                    <a href="{{ url_for('ver_consulta', id=consulta.id) }}" 
                       class="inline-flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors duration-200">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-medium rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-prescription-bottle-alt mr-2"></i> Prescribir Medicamento
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar de Información -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6 space-y-6">
                <!-- Información del Paciente -->
                <div>
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-paw text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Información del Paciente</h3>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-500">Mascota</p>
                            <p class="font-medium text-gray-900">{{ historia.nombre_mascota }}</p>
                        </div>
                        
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-500">Propietario</p>
                            <p class="font-medium text-gray-900">{{ historia.nombre_propietario }}</p>
                        </div>
                        
                        {% if consulta.peso %}
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-500">Peso Actual</p>
                            <p class="font-medium text-gray-900">{{ consulta.peso }} kg</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Medicamentos Actuales -->
                {% if medicamentos_actuales %}
                <div>
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Medicamentos Actuales</h3>
                    </div>
                    
                    <div class="space-y-2">
                        {% for med in medicamentos_actuales %}
                        <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                            <p class="text-sm font-medium text-red-800">{{ med.nombre_medicamento }}</p>
                            <p class="text-xs text-red-600">{{ med.dosis }} - {{ med.frecuencia }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Guía de Dosificación -->
                <div>
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-calculator text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Calculadora de Dosis</h3>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-semibold text-green-700">Dosis por kg:</label>
                                <input type="number" id="calc-dosis-kg" step="0.1" placeholder="mg/kg"
                                       class="w-full px-2 py-1 text-sm border border-green-300 rounded">
                            </div>
                            {% if consulta.peso %}
                            <div>
                                <label class="text-xs font-semibold text-green-700">Peso: {{ consulta.peso }} kg</label>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-green-700">Dosis total:</label>
                                <div id="calc-resultado" class="text-sm font-medium text-green-800 bg-white p-2 rounded border">
                                    --
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Información de Ayuda -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">
                        <i class="fas fa-lightbulb mr-1"></i> Recordatorios
                    </h4>
                    <ul class="text-xs text-blue-700 space-y-1">
                        <li>• Verificar alergias medicamentosas</li>
                        <li>• Considerar interacciones farmacológicas</li>
                        <li>• Ajustar dosis según peso y condición</li>
                        <li>• Especificar vía de administración</li>
                        <li>• Incluir duración del tratamiento</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// Mostrar información del medicamento seleccionado
document.getElementById('idmedicamento').addEventListener('change', function() {
    const select = this;
    const selectedOption = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('info-medicamento');
    
    if (selectedOption.value) {
        document.getElementById('principio-activo').textContent = 'No especificado';
        document.getElementById('forma-farmaceutica').textContent = 'No especificado';
        document.getElementById('concentracion').textContent = selectedOption.dataset.presentacion || 'No especificado';
        infoDiv.classList.remove('hidden');
    } else {
        infoDiv.classList.add('hidden');
    }
});

// Mostrar campo personalizado para frecuencia
document.getElementById('frecuencia').addEventListener('change', function() {
    const customDiv = document.getElementById('frecuencia-personalizada');
    if (this.value === 'Personalizada') {
        customDiv.classList.remove('hidden');
        document.getElementById('frecuencia_custom').required = true;
    } else {
        customDiv.classList.add('hidden');
        document.getElementById('frecuencia_custom').required = false;
    }
});

// Calculadora de dosis
{% if consulta.peso %}
document.getElementById('calc-dosis-kg').addEventListener('input', function() {
    const dosisKg = parseFloat(this.value);
    const peso = {{ consulta.peso }};
    const resultado = document.getElementById('calc-resultado');
    
    if (dosisKg && peso) {
        const dosisTotal = (dosisKg * peso).toFixed(2);
        resultado.textContent = `${dosisTotal} mg`;
    } else {
        resultado.textContent = '--';
    }
});
{% endif %}

// Validación del formulario
document.querySelector('form').addEventListener('submit', function(e) {
    const frecuencia = document.getElementById('frecuencia').value;
    const frecuenciaCustom = document.getElementById('frecuencia_custom').value;
    
    if (frecuencia === 'Personalizada' && !frecuenciaCustom.trim()) {
        e.preventDefault();
        alert('Por favor, especifique la frecuencia personalizada.');
        document.getElementById('frecuencia_custom').focus();
        return false;
    }
    
    // Cambiar texto del botón durante el envío
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Prescribiendo...';
    submitBtn.disabled = true;
});

// Auto-focus en el primer campo
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('idmedicamento').focus();
});
</script>
{% endblock %}
